#!/usr/bin/env bash
#
# TSiJUKEBOX Enterprise - Launcher Script
# Maintainer: B0.y_Z4kr14
#

set -euo pipefail

# Configuration
readonly APP_NAME="TSiJUKEBOX"
readonly APP_DIR="/opt/tsijukebox"
readonly CONFIG_DIR="/etc/tsijukebox"
readonly LOG_DIR="/var/log/tsijukebox"
readonly CONFIG_FILE="${CONFIG_DIR}/config.json"
readonly LOG_FILE="${LOG_DIR}/tsijukebox.log"

# Default values
KIOSK_MODE="${TSIJUKEBOX_KIOSK:-false}"
FULLSCREEN="${TSIJUKEBOX_FULLSCREEN:-true}"
DEBUG="${TSIJUKEBOX_DEBUG:-false}"
SERVER_MODE="${TSIJUKEBOX_SERVER:-false}"
PORT="${TSIJUKEBOX_PORT:-5173}"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Functions
log() {
    local level="$1"
    shift
    local message="$*"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${timestamp} [${level}] ${message}" | tee -a "${LOG_FILE}" 2>/dev/null || echo -e "${timestamp} [${level}] ${message}"
}

log_info() { log "INFO" "$@"; }
log_warn() { log "WARN" "${YELLOW}$*${NC}"; }
log_error() { log "ERROR" "${RED}$*${NC}"; }
log_success() { log "INFO" "${GREEN}$*${NC}"; }

show_banner() {
    echo -e "${BLUE}"
    cat << 'EOF'
  ╔════════════════════════════════════════════════════════════╗
  ║                                                            ║
  ║   ████████╗███████╗██╗     ██╗██╗   ██╗██╗  ██╗███████╗   ║
  ║      ██╔══╝██╔════╝██║     ██║██║   ██║██║ ██╔╝██╔════╝   ║
  ║      ██║   ███████╗██║     ██║██║   ██║█████╔╝ █████╗     ║
  ║      ██║   ╚════██║██║██   ██║██║   ██║██╔═██╗ ██╔══╝     ║
  ║      ██║   ███████║██║╚█████╔╝╚██████╔╝██║  ██╗███████╗   ║
  ║      ╚═╝   ╚══════╝╚═╝ ╚════╝  ╚═════╝ ╚═╝  ╚═╝╚══════╝   ║
  ║                                                            ║
  ║                    Enterprise Music System                 ║
  ║                        Version 4.0.0                       ║
  ║                                                            ║
  ╚════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

show_help() {
    show_banner
    cat << EOF
Usage: tsijukebox [OPTIONS]

Options:
    -k, --kiosk         Run in kiosk mode (fullscreen, no window decorations)
    -f, --fullscreen    Run in fullscreen mode
    -w, --windowed      Run in windowed mode
    -s, --server        Start development server only (no browser)
    -p, --port PORT     Set server port (default: 5173)
    -d, --debug         Enable debug mode
    -h, --help          Show this help message
    -v, --version       Show version information

Environment Variables:
    TSIJUKEBOX_KIOSK        Enable kiosk mode (true/false)
    TSIJUKEBOX_FULLSCREEN   Enable fullscreen (true/false)
    TSIJUKEBOX_DEBUG        Enable debug mode (true/false)
    TSIJUKEBOX_SERVER       Server-only mode (true/false)
    TSIJUKEBOX_PORT         Server port (default: 5173)

Examples:
    tsijukebox                  # Start in default mode
    tsijukebox --kiosk          # Start in kiosk mode
    tsijukebox --server -p 8080 # Start server on port 8080
    tsijukebox --debug          # Start with debug logging

Documentation: https://github.com/B0yZ4kr14/TSiJUKEBOX
Report bugs: https://github.com/B0yZ4kr14/TSiJUKEBOX/issues
EOF
}

show_version() {
    echo "${APP_NAME} 4.0.0"
    echo "Copyright (c) 2025 B0.y_Z4kr14"
    echo "License: Public Domain"
}

check_dependencies() {
    local missing=()
    
    for cmd in chromium; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing dependencies: ${missing[*]}"
        log_info "Install with: sudo pacman -S ${missing[*]}"
        exit 1
    fi
}

check_app_files() {
    if [[ ! -d "${APP_DIR}" ]]; then
        log_error "Application directory not found: ${APP_DIR}"
        exit 1
    fi
    
    if [[ ! -f "${APP_DIR}/index.html" ]]; then
        log_error "Application files not found in ${APP_DIR}"
        exit 1
    fi
}

load_config() {
    if [[ -f "${CONFIG_FILE}" ]]; then
        log_info "Loading configuration from ${CONFIG_FILE}"
        
        if command -v jq &> /dev/null; then
            KIOSK_MODE=$(jq -r '.kiosk_mode // false' "${CONFIG_FILE}" 2>/dev/null || echo "false")
        fi
    fi
}

build_chromium_args() {
    local args=(
        "--app=file://${APP_DIR}/index.html"
        "--disable-translate"
        "--disable-features=TranslateUI"
        "--disable-infobars"
        "--disable-suggestions-service"
        "--disable-save-password-bubble"
        "--disable-session-crashed-bubble"
        "--no-first-run"
        "--fast"
        "--fast-start"
        "--autoplay-policy=no-user-gesture-required"
        "--enable-features=OverlayScrollbar"
    )
    
    if [[ "${KIOSK_MODE}" == "true" ]]; then
        args+=(
            "--kiosk"
            "--start-fullscreen"
            "--start-maximized"
            "--hide-scrollbars"
            "--disable-pinch"
            "--overscroll-history-navigation=0"
        )
    elif [[ "${FULLSCREEN}" == "true" ]]; then
        args+=(
            "--start-fullscreen"
            "--start-maximized"
        )
    fi
    
    if [[ "${DEBUG}" == "true" ]]; then
        args+=(
            "--enable-logging"
            "--v=1"
        )
    fi
    
    echo "${args[@]}"
}

start_app() {
    log_info "Starting ${APP_NAME}..."
    
    local chromium_args
    chromium_args=$(build_chromium_args)
    
    if [[ "${DEBUG}" == "true" ]]; then
        log_info "Chromium args: ${chromium_args}"
    fi
    
    # shellcheck disable=SC2086
    exec chromium ${chromium_args}
}

# Parse arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -k|--kiosk)
                KIOSK_MODE="true"
                shift
                ;;
            -f|--fullscreen)
                FULLSCREEN="true"
                shift
                ;;
            -w|--windowed)
                FULLSCREEN="false"
                KIOSK_MODE="false"
                shift
                ;;
            -s|--server)
                SERVER_MODE="true"
                shift
                ;;
            -p|--port)
                PORT="$2"
                shift 2
                ;;
            -d|--debug)
                DEBUG="true"
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            *)
                log_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# Main
main() {
    parse_args "$@"
    
    if [[ "${DEBUG}" == "true" ]]; then
        show_banner
    fi
    
    check_dependencies
    check_app_files
    load_config
    
    if [[ "${SERVER_MODE}" == "true" ]]; then
        log_info "Server mode is not available for installed package"
        log_info "Use 'npm run dev' in the source directory instead"
        exit 1
    fi
    
    start_app
}

main "$@"
