# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                              â•‘
# â•‘   TSiJUKEBOX - UAT Installation Tests Workflow                               â•‘
# â•‘   Executa testes de aceitaÃ§Ã£o do usuÃ¡rio para instalaÃ§Ã£o autÃ´noma            â•‘
# â•‘                                                                              â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ§ª UAT Installation Tests

on:
  # ExecuÃ§Ã£o manual via interface do GitHub
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de execuÃ§Ã£o dos testes'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - dry-run
          - full
      test_number:
        description: 'NÃºmero do teste especÃ­fico (1-4) ou "all" para todos'
        required: true
        default: 'all'
        type: string

  # ExecuÃ§Ã£o automÃ¡tica em push para main (opcional)
  # push:
  #   branches: [main]
  #   paths:
  #     - 'scripts/unified-installer.py'
  #     - 'scripts/uat-installation-tests.py'

jobs:
  uat-tests:
    name: ðŸ§ª Executar Testes UAT
    runs-on: ubuntu-22.04
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SETUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ðŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install colorama
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # EXECUÃ‡ÃƒO DOS TESTES
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ðŸ“‹ Listar testes disponÃ­veis
        run: |
          python3 scripts/uat-installation-tests.py --list
      
      - name: ðŸ§ª Executar testes UAT
        id: run_tests
        run: |
          mkdir -p docs/test-reports
          
          # Determinar argumentos
          TEST_ARGS=""
          
          if [ "${{ github.event.inputs.test_number }}" = "all" ]; then
            TEST_ARGS="--all"
          else
            TEST_ARGS="--test ${{ github.event.inputs.test_number }}"
          fi
          
          if [ "${{ github.event.inputs.test_mode }}" = "dry-run" ]; then
            TEST_ARGS="$TEST_ARGS --dry-run"
          fi
          
          # Executar testes
          python3 scripts/uat-installation-tests.py $TEST_ARGS --report --verbose
          
          # Capturar nome do relatÃ³rio
          REPORT_FILE=$(ls -t docs/test-reports/uat-installation-report_*.md | head -1)
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Exibir relatÃ³rio
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    RELATÃ“RIO DE TESTES UAT                     "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat ${{ steps.run_tests.outputs.report_file }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # COMMIT DO RELATÃ“RIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ðŸ“ Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: ðŸ’¾ Commit do relatÃ³rio
        run: |
          git add docs/test-reports/
          
          # Verificar se hÃ¡ alteraÃ§Ãµes
          if git diff --staged --quiet; then
            echo "Nenhuma alteraÃ§Ã£o para commitar"
          else
            git commit -m "test: adiciona relatÃ³rio de testes UAT de instalaÃ§Ã£o

          Modo: ${{ github.event.inputs.test_mode }}
          Testes: ${{ github.event.inputs.test_number }}
          
          CenÃ¡rios testados:
          - UAT-INST-01: InstalaÃ§Ã£o Completa (modo full)
          - UAT-INST-02: InstalaÃ§Ã£o em Modo Kiosk
          - UAT-INST-03: SimulaÃ§Ã£o (dry-run)
          - UAT-INST-04: InstalaÃ§Ã£o com SSL
          
          Gerado automaticamente por GitHub Actions"
            
            git push
          fi
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ARTEFATOS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ðŸ“¤ Upload do relatÃ³rio como artefato
        uses: actions/upload-artifact@v4
        with:
          name: uat-installation-report
          path: docs/test-reports/uat-installation-report_*.md
          retention-days: 30
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # SUMÃRIO
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ðŸ“Š Gerar sumÃ¡rio do workflow
        run: |
          echo "## ðŸ§ª Resultados dos Testes UAT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ParÃ¢metro | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Modo** | ${{ github.event.inputs.test_mode }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Testes** | ${{ github.event.inputs.test_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Data** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ RelatÃ³rio" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ${{ steps.run_tests.outputs.report_file }} >> $GITHUB_STEP_SUMMARY
